# CDN加速实现-Varnish

## 一、CDN简介

​	   CDN的全称是Content Delivery Network，即内容分发网络。CDN是构建在现有网络基础之上的智能虚拟网络，其基本思路是尽可能避开互联网上有可能影响数据传输速度和稳定性的瓶颈和环节，使内容传输得更快、更稳定。依靠部署在各地的边缘服务器，通过中心平台的负载均衡、内容分发、调度等功能模块，使用户就近获取所需内容，降低网络拥塞，提高用户访问响应速度和命中率。CDN的关键技术主要有内容存储和分发技术。
​		内容分发网络是一个经策略性部署的整体系统，包括分布式存储、负载均衡、网络请求的重定向和内容管理4个要求，而内容管理和全局的网络流量管理]是CDN的核心所在。通过用户就近性和服务器负载的判断，CDN确保内容以一种极为高效的方式为用户的请求提供服务。
​	    总的来说，内容服务基于缓存服务器，也称代理缓存，它位于网络的边缘，距用户仅有"一跳"之遥。同时，代理缓存是内容提供商源服务器的一个透明镜像。这样的架构使得CDN服务提供商能够代表他们客户，即内容供应商，向最终用户提供尽可能好的体验，而这些用户是不能容忍请求响应时间有任何延迟的。

## 二、缓存相关概念简述

- 时间局部性：一个数据被访问过之后，可能很快会被再次访问到；
- 空间局部性：一个数据被访问时，其周边的数据也有可能被访问到
- 数据缓存：例如MySQL到web应用服务器之间的缓存服务器缓存的资源是数据缓存
- 页面缓存：接入层和应用层中间的缓存服务器缓存的是可缓存的页面，这层就是缓存层
- 缓存命中率：hit/(hit+miss)，一般高于30%命中率则是正向收益，好的设计系统可以达到80%到95%以上
- 字节命中率：按照数据的字节大小来计算命中率
- 请求命中率：按照请求的数量来计算命中率
- 代理式缓存：客户端访问缓存服务器，缓存服务器没有命中缓存时到后端服务器请求数据，此时它作为反向代理服务器工作，这种类型的缓存服务器叫做代理式缓存
- 旁挂式缓存：客户端亲自去查询数据库，并且将数据复制给缓存服务器一份，下次先去找缓存服务器，如果没有命中则再去数据库服务器查询，此时这种工作方式的缓存叫做旁挂式缓存，这个客户端叫做胖客户端（smart client）
- private cache：私有缓存，用户代理附带的本地缓存机制，例如浏览器本身带有的缓存，就属于私有缓存的一种。
- public cache：公共缓存，反向代理服务器的缓存功能
- CDN：Content Delivery Network 内容分发网路
- GSLB：全网均衡调度
- 缓存有效性判断机制：
  - 过期时间
  - 条件式验证
    - Last-Modified/If-Modified-Since：基于文件的修改时间戳来判别
    - Etag/If-None-Match：基于文件的校验码来判别

>  ​       **过期时间验证**缓存是否失效颗粒度太大，如果页面刚刚缓存应用服务器发生了变化，结果客户端拿到的就是过期数据；从而加入了**条件式验证**缓存的失效性，每次客户端请求到达缓存服务器，缓存服务器都要拿本地的数据和应用服务器的数据比较时间戳，如果时间戳发生了变化则缓存新的数据；这样虽然粒度小了，但是还是会有问题，如果应用服务器在同一秒页面数据变化了三次，而缓存服务器拿到的是第一份数据，这样还是会发生数据失效的问题；从而又引入了**Etag（扩展标记）**来标记唯一的页面数据。此时虽然解决了数据失效性的问题，但是每次客户端的请求都要去后端服务器做比较，对缓存和应用服务器都是不小的压力，我们不得不采取折中的解决方案就是“过期时间验证+条件式验证”，将不经常变动的页面做过期时间验证，变动频繁的采用条件式验证。

请求报文用于通知缓存服务如何使用缓存响应请求：

```
cache-request-directive = 
"no-cache" 不能使用缓存系统中的缓存响应我，必须先去应用服务器做缓存验证
"no-store" 不能使用缓存系统中的缓存响应我，必须去应用服务器请求响应我
"max-age" "=" delta-seconds 
"max-stale" [ "=" delta-seconds ]
"min-fresh" "=" delta-seconds
"no-transform"
"only-if-cached"
cache-extension
```

响应报文用于通知缓存服务器如何存储上级服务器响应的内容：

```
cache-response-directive =
"public" 所有缓存系统都可以缓存
"private" [ "=" <"> 1#field-name <"> ] 仅能够被私有缓存所缓存
"no-cache" [ "=" <"> 1#field-name <"> ]，可缓存，但响应给客户端之前需要revalidation，即必须发出条件式请求进行缓存有效性验正
"no-store" ，不允许存储响应内容于缓存中
"no-transform" 不能转换格式
"must-revalidate" 必须重新验证
"proxy-revalidate" 
"max-age" "=" delta-seconds 私有缓存最大缓存时长
"s-maxage" "=" delta-seconds 公共缓存最大缓存时长
cache-extension
```

> Web Page Cache解决方案：squid和varnish，它们的关系就像Apache和Nginx，apache和squid是比较早的负载均衡服务器和缓存服务器，nginx和varnish是比较流行的负载均衡服务器和缓存服务器。